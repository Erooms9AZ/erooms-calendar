// ---------------------------------------------------------
//  DURATION BUTTONS
// ---------------------------------------------------------
document.querySelectorAll("#durationButtons button").forEach(btn => {
  btn.addEventListener("click", () => {
    document
      .querySelectorAll("#durationButtons button")
      .forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedDuration = Number(btn.dataset.hours);
    renderMobileSlots();
  });
});
//--------------------------------------------------------
// EARLIEST DAY CHECK (shared by Prev button + swipe)
//--------------------------------------------------------
function isAtEarliestDay() {
  // Determine the earliest allowed day (skip Sunday)
  const earliest = new Date();
  if (earliest.getDay() === 0) {
    earliest.setDate(earliest.getDate() + 1); // move Sunday → Monday
  }

  return (
    mobileCurrentDay.getFullYear() === earliest.getFullYear() &&
    mobileCurrentDay.getMonth() === earliest.getMonth() &&
    mobileCurrentDay.getDate() === earliest.getDate()
  );
}

//--------------------------------------------------------
// UPDATE PREV BUTTON STATE
//--------------------------------------------------------
function updatePrevButtonState() {
  const btn = document.getElementById("prevDayBtn");
  if (!btn) return;

  // Determine the earliest allowed day (skip Sunday)
  const earliest = new Date();
  if (earliest.getDay() === 0) {
    earliest.setDate(earliest.getDate() + 1); // move Sunday → Monday
  }

  // Compare earliest allowed day with current day
  const isEarliest =
    mobileCurrentDay.getFullYear() === earliest.getFullYear() &&
    mobileCurrentDay.getMonth() === earliest.getMonth() &&
    mobileCurrentDay.getDate() === earliest.getDate();

  if (isEarliest) {
    btn.classList.add("disabled");
  } else {
    btn.classList.remove("disabled");
  }
}



// ---------------------------------------------------------
//  NAVIGATION (SKIP SUNDAY)
// ---------------------------------------------------------
document.getElementById("prevDayBtn")?.addEventListener("click", () => {

  const today = new Date();
  today.setHours(0,0,0,0);

  const checkDay = new Date(mobileCurrentDay);
  checkDay.setHours(0,0,0,0);

  // Only block when actually on today
  const onToday = checkDay.getTime() === today.getTime();

  if (onToday) {
    return;
  }

  // Move back one day, skipping Sunday
  do {
    mobileCurrentDay.setDate(mobileCurrentDay.getDate() - 1);
  } while (mobileCurrentDay.getDay() === 0);

  updateDayLabel();
  renderMobileSlots();
  updatePrevButtonState();
});


document.getElementById("nextDayBtn")?.addEventListener("click", () => {
  do {
    mobileCurrentDay.setDate(mobileCurrentDay.getDate() + 1);
  } while (mobileCurrentDay.getDay() === 0);
  updateDayLabel();
  renderMobileSlots();
  updatePrevButtonState(); // <-- THIS is the missing line
});
// ---------------------------------------------------------
//  BOOKING FORM BUTTONS
// ---------------------------------------------------------

// Cancel booking
document.getElementById("bfCancel")?.addEventListener("click", () => {
  document.getElementById("bookingOverlay").style.display = "none";
});

//-------------------------------------------------------
// RESET BOOKING FORM
//-------------------------------------------------------
function resetBookingForm() {
  document.getElementById("bfName").value = "";
  document.getElementById("bfEmail").value = "";
  document.getElementById("bfPhone").value = "";
  document.getElementById("bfComments").value = "";
  document.getElementById("bookingStatus").textContent = "";
}

//-------------------------------------------------------
// CANCEL BOOKING
//-------------------------------------------------------
document.getElementById("bfCancel")?.addEventListener("click", () => {
  document.getElementById("bookingOverlay").style.display = "none";
  resetBookingForm();
});

//-------------------------------------------------------
// SUBMIT BOOKING
//-------------------------------------------------------
document.getElementById("bfSubmit")?.addEventListener("click", async () => {
  const name = document.getElementById("bfName").value.trim();
  const email = document.getElementById("bfEmail").value.trim();
  const phone = document.getElementById("bfPhone").value.trim();
  const comments = document.getElementById("bfComments").value.trim();

  if (!name || !email || !phone) {
    document.getElementById("bookingStatus").textContent =
      "Please fill in all required fields.";
    return;
  }

  document.getElementById("bookingStatus").textContent = "Submitting...";

  const payload = {
    name,
    email,
    phone,
    comments,
    room: window.selectedRoom,
    start: window.selectedStart.toISOString(),
    end: window.selectedEnd.toISOString()
  };

  const BOOKING_URL = "https://script.google.com/macros/s/AKfycbxzW6PrNFeoYLGKx4ugcUSpNa9n_QTCi7GAPknr4Bw0XOYrsebqhJ2uGbx4FSNV2-70Wg/exec";

  try {
    await fetch(BOOKING_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // Treat as success (Apps Script always returns opaque responses)
    document.getElementById("bookingForm").style.display = "none";
    document.getElementById("successMessage").textContent =
      "Your booking has been submitted successfully! The calendar has been updated.";
    document.getElementById("successBox").style.display = "block";

    await renderMobileSlots(); // refresh calendar

  } catch (err) {
    // Silent fallback — do NOT show an error
    document.getElementById("bookingStatus").textContent = "Submitting…";
  }
});

//-------------------------------------------------------
// SUCCESS OK (ONLY ONE HANDLER)
//-------------------------------------------------------
document.getElementById("successOk")?.addEventListener("click", () => {
  document.getElementById("bookingOverlay").style.display = "none";
  document.getElementById("successBox").style.display = "none";
  document.getElementById("bookingForm").style.display = "block";
  resetBookingForm();
});
//-------------------------------------------------------
// SWIPE TO CHANGE WEEK + SLIDE ANIMATION
//-------------------------------------------------------
let touchStartX = 0;
let touchEndX = 0;

const swipeArea = document.getElementById("slotList");

swipeArea.addEventListener("touchstart", (e) => {
  touchStartX = e.changedTouches[0].screenX;
});

swipeArea.addEventListener("touchend", (e) => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
});

function handleSwipe() {
  const swipeDistance = touchEndX - touchStartX;
  const threshold = 60; // minimum swipe distance

  if (swipeDistance < -threshold) {
    animateNext();
  }

  if (swipeDistance > threshold) {
    animatePrev();
  }
}

function animateNext() {
  const slotList = document.getElementById("slotList");
  slotList.style.transform = "translateX(-100%)";

  setTimeout(() => {
    slotList.style.transform = "translateX(0)";
    document.getElementById("nextDayBtn").click();
  }, 250);
}

function animatePrev() {
  if (isAtEarliestDay()) {
    return; // block swipe-back beyond week 1 Monday
  }

  const slotList = document.getElementById("slotList");
  slotList.style.transform = "translateX(100%)";

  setTimeout(() => {
    slotList.style.transform = "translateX(0)";
    document.getElementById("prevDayBtn").click();
  }, 250);
}


// ---------------------------------------------------------
//  INIT
// ---------------------------------------------------------
(async () => {
  updateDayLabel();
  await renderMobileSlots();
  updatePrevButtonState();

})();
